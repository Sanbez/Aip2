<% layout('/layout/page.ejs') %>

<div class="container">
    <div class="hero-section">
        <h1 class="hero-title">Добро пожаловать в LUNA</h1>
        <p class="hero-subtitle">Исследуйте красоту и тайны нашего единственного естественного спутника</p>
    </div>

    <div class="row mt-5">
        <div class="col-lg-6">
            <!-- 3D модель Луны -->
            <div id="moon-container" class="moon-container"></div>
        </div>
        <div class="col-lg-6">
            <div class="moon-info-card">
                <h2 class="section-title">Текущая фаза Луны</h2>
                <div class="phase-info">
                    <h3 class="phase-name"><%= phaseName %></h3>
                    <p class="phase-illumination">Освещенность: <span class="highlight"><%= illumination %>%</span></p>
                    <div class="phase-description">
                        <p>Сейчас Луна находится в фазе <strong><%= phaseName.toLowerCase() %></strong>.
                        Поверхность освещена на <%= illumination %>%.</p>
                    </div>
                </div>
                <div class="moon-stats">
                    <div class="stat-item">
                        <span class="stat-label">Расстояние от Земли</span>
                        <span class="stat-value">384,400 км</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Диаметр</span>
                        <span class="stat-value">3,474 км</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Орбитальный период</span>
                        <span class="stat-value">27.3 дней</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cta-section">
        <h2>Исследуйте больше</h2>
        <p>Узнайте о фазах луны, интересных фактах и поделитесь своими наблюдениями</p>
        <div class="cta-buttons">
            <a href="/phases" class="btn btn-primary-custom">Фазы Луны</a>
            <a href="/facts" class="btn btn-secondary-custom">Факты</a>
            <a href="/observations" class="btn btn-accent-custom">Мои наблюдения</a>
        </div>
    </div>
</div>

<!-- Three.js CDN -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>
<script type="module">
import * as THREE from 'three';

let scene, camera, renderer, moon;
let mouseX = 0, mouseY = 0;
let targetRotationX = 0, targetRotationY = 0;

function init() {
    const container = document.getElementById('moon-container');
    if (!container) return;

    const width = container.clientWidth;
    const height = container.clientHeight || 400;

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.z = 3;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const geometry = new THREE.SphereGeometry(1, 64, 64);
    const material = new THREE.MeshStandardMaterial({
        color: 0xcccccc,
        roughness: 0.9,
        metalness: 0.1,
        emissive: 0x333333,
        emissiveIntensity: 0.2
    });

    moon = new THREE.Mesh(geometry, material);
    scene.add(moon);

    const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
    directionalLight.position.set(5, 3, 5);
    scene.add(directionalLight);

    const rimLight = new THREE.DirectionalLight(0x6699ff, 0.5);
    rimLight.position.set(-5, 0, -5);
    scene.add(rimLight);

    container.addEventListener('mousemove', onMouseMove);
    container.addEventListener('mouseleave', onMouseLeave);
    window.addEventListener('resize', onWindowResize);

    animate();
}

function onMouseMove(event) {
    const container = document.getElementById('moon-container');
    const rect = container.getBoundingClientRect();
    mouseX = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouseY = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    targetRotationY = mouseX * 0.5;
    targetRotationX = mouseY * 0.3;
}

function onMouseLeave() {
    targetRotationX = 0;
    targetRotationY = 0;
}

function onWindowResize() {
    const container = document.getElementById('moon-container');
    if (!container) return;
    const width = container.clientWidth;
    const height = container.clientHeight || 400;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

function animate() {
    requestAnimationFrame(animate);
    moon.rotation.y += 0.002;
    moon.rotation.x += (targetRotationX - moon.rotation.x) * 0.05;
    moon.rotation.y += (targetRotationY - moon.rotation.y) * 0.05;
    renderer.render(scene, camera);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
